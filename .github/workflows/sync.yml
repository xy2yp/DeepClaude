name: Sync Upstream Code

on:
  schedule:
    # æ¯å¤©æ™šä¸Š 0 ç‚¹æ•´è¿è¡Œ
    - cron: '0 0 * * *'

jobs:
  sync:
    runs-on: ubuntu-latest

    steps:
      # Step 1: æ£€æŸ¥å‡ºç›®æ ‡ä»“åº“ä»£ç 
      - name: Checkout Target Repository
        uses: actions/checkout@v3
        with:
          ref: main # ç¡®ä¿ä½¿ç”¨ä¸»åˆ†æ”¯ï¼Œä¿®æ”¹ä¸ºä½ çš„é»˜è®¤åˆ†æ”¯åç§°

      # Step 2: æ·»åŠ ä¸Šæ¸¸ä»“åº“ä¸º remote
      - name: Add Upstream Repository
        run: |
          git remote add upstream https://github.com/ErlichLiu/DeepClaude.git
          git fetch upstream

      # Step 3: åŒæ­¥ä¸Šæ¸¸ä»£ç 
      - name: Sync Upstream Changes
        id: sync # ç»™æ­¥éª¤è®¾ç½®ä¸€ä¸ª IDï¼Œä¾›åç»­æ¡ä»¶åˆ¤æ–­ä½¿ç”¨
        run: |
          # åˆå¹¶ä¸Šæ¸¸ä»£ç åˆ°å½“å‰åˆ†æ”¯
          git merge upstream/main --no-commit --no-ff || true
          
          # æ’é™¤ä¸éœ€è¦è¦†ç›–çš„æ–‡ä»¶
          git restore --staged .github/workflows/docker-build.yml
          git restore --staged .github/workflows/sync.yml

          # æäº¤æ›´æ”¹
          git commit -m "Sync with upstream" || echo "No changes to commit"

      # Step 4: æ¨é€æ›´æ”¹åˆ°ç›®æ ‡ä»“åº“
      - name: Push Changes
        id: push # ç»™æ­¥éª¤è®¾ç½®ä¸€ä¸ª IDï¼Œä¾›åç»­æ¡ä»¶åˆ¤æ–­ä½¿ç”¨
        run: |
          git push origin main || echo "No changes to push"

      # Step 5: å‘é€ WXPusher æ¶ˆæ¯é€šçŸ¥ï¼ˆä»…åœ¨æœ‰æ›´æ–°æˆ–åŒæ­¥å¤±è´¥æ—¶ï¼‰
      - name: Send Notification
        if: steps.sync.outcome == 'success' && steps.push.outcome == 'success' && steps.sync.outputs.result != 'No changes to commit' || failure()
        env:
          WXPUSHER_APP_TOKEN: ${{ secrets.WXPUSHER_APP_TOKEN }}
          WXPUSHER_UID: ${{ secrets.WXPUSHER_UID }}
        run: |
          if [ "$(git log -1 --pretty=%B)" != "No changes to commit" ]; then
            MESSAGE="âœ… [GitHub Actions] åŒæ­¥å®Œæˆï¼\n\n- ä»“åº“ï¼š${{ github.repository }}\n- åˆ†æ”¯ï¼šmain\n- æ›´æ–°å†…å®¹ï¼š$(git log -1 --pretty=%B)\n\nğŸ”— [æŸ¥çœ‹ä»“åº“](${{ github.server_url }}/${{ github.repository }})"
          else
            MESSAGE="âŒ [GitHub Actions] åŒæ­¥å¤±è´¥ï¼Œè¯·æ£€æŸ¥æ—¥å¿—ã€‚\n\n- ä»“åº“ï¼š${{ github.repository }}\n- åˆ†æ”¯ï¼šmain\n\nğŸ”— [æŸ¥çœ‹ä»“åº“](${{ github.server_url }}/${{ github.repository }})"
          fi

          # è°ƒç”¨ WXPusher API å‘é€æ¶ˆæ¯
          curl -s -X POST "https://wxpusher.zjiecode.com/api/send/message" \
            -H "Content-Type: application/json" \
            -d '{
              "appToken": "'"$WXPUSHER_APP_TOKEN"'",
              "content": "'"$MESSAGE"'",
              "summary": "DeepClaude åŒæ­¥é€šçŸ¥",
              "contentType": 3,
              "uids": ["'"$WXPUSHER_UID"'"]
            }'
